
# Problem #323

> This problem was asked by Dropbox.
>
> Create an algorithm to efficiently compute the approximate median of a list of numbers.
>
> More precisely, given an unordered list of N numbers, find an element whose rank is between N / 4 and 3 * N / 4, with a high level of certainty, in less than O(N) time.


```python
import random
import time
from collections import defaultdict as deft
```


```python
LENGTHS = [10, 100, 1000, 10000, 100000]
# LENGTHS = [10]
N_EXPERIMENTS = 20

def generate_instances(l):
    pool = range(l * random.randrange(1, 100))
    sampled = random.sample(pool, l)
    return sampled

def avg(values):
    return sum(values) / len(values)

def median(values):
    space = [x for x in values]
    space.sort()
    l = int(float(len(space) / 2))
    return space[l]

def median_rank_ratio(x, values):
    space = [y for y in values]
    space.sort()
    try:
        i = space.index(x)
        minim = len(space) / 4.0
        return (i / minim) - 1.0
    except ValueError:
        return -1
```


```python
def approx_median(data):
    
    def get_magnitude(l, base=10):
        magnitudes = 1
        while True:
            if l <= base:
                break
            magnitudes += 1
            l /= base
        return magnitudes
    
    l = len(data)
    magnitude = get_magnitude(l)
    if magnitude > 3:
        magnitude = get_magnitude(l, base=100)
    
    n = 10 ** (magnitude - 1)
    n = n if n <= l and n >= 10 else l
    
    candidates = random.sample(data, n)
    mdn = median(candidates)

    return mdn
```


```python
times = deft(list)
deltas = deft(list)

for length in LENGTHS:
    for experiment in range(N_EXPERIMENTS):
        data = generate_instances(length)
        mdn = median(data)
        start = time.time()
        approx = approx_median(data)
        duration = time.time() - start
        mrr = median_rank_ratio(approx, data)
        print approx, '/%d' % mdn, mrr, duration
        times[length].append(duration)
        deltas[length].append(mrr)

print '---'
for i, length in enumerate(LENGTHS):
    if not i:
        continue
    prev = LENGTHS[i - 1]
    prev_tm = avg(times[prev])
    avg_tm = avg(times[length])
    print length, avg(deltas[length]), avg_tm, avg_tm / prev_tm

```

    66 /66 1.0 7.00950622559e-05
    392 /392 1.0 0.000109195709229
    10 /10 1.0 1.71661376953e-05
    7 /7 1.0 2.00271606445e-05
    476 /476 1.0 1.69277191162e-05
    129 /129 1.0 1.31130218506e-05
    247 /247 1.0 1.09672546387e-05
    8 /8 1.0 1.4066696167e-05
    279 /279 1.0 2.59876251221e-05
    138 /138 1.0 1.81198120117e-05
    137 /137 1.0 1.19209289551e-05
    174 /174 1.0 1.69277191162e-05
    10 /10 1.0 1.38282775879e-05
    368 /368 1.0 2.09808349609e-05
    35 /35 1.0 1.81198120117e-05
    490 /490 1.0 2.00271606445e-05
    32 /32 1.0 1.78813934326e-05
    184 /184 1.0 1.50203704834e-05
    330 /330 1.0 1.81198120117e-05
    576 /576 1.0 1.90734863281e-05
    3580 /3733 0.84 0.000176906585693
    699 /1090 0.6 2.59876251221e-05
    62 /50 1.48 2.00271606445e-05
    2077 /1943 1.16 2.09808349609e-05
    1380 /1114 1.52 2.09808349609e-05
    2317 /1705 1.56 1.81198120117e-05
    1111 /1255 0.88 2.09808349609e-05
    217 /233 0.76 2.09808349609e-05
    619 /1264 0.04 2.40802764893e-05
    3420 /4563 0.2 1.97887420654e-05
    2048 /2360 0.72 2.00271606445e-05
    231 /201 1.2 4.57763671875e-05
    2098 /2361 0.84 2.40802764893e-05
    865 /1189 0.44 2.19345092773e-05
    5082 /4799 1.12 3.00407409668e-05
    3609 /4531 0.52 3.00407409668e-05
    2749 /2187 1.56 2.40802764893e-05
    5840 /5073 1.32 2.59876251221e-05
    2479 /1975 1.6 2.00271606445e-05
    454 /281 1.96 2.09808349609e-05
    5818 /5119 1.256 0.000118017196655
    28076 /25997 1.172 0.000130176544189
    3123 /2566 1.436 0.000102996826172
    41959 /37517 1.244 0.000135183334351
    1036 /1008 1.064 0.000104904174805
    26274 /31143 0.68 0.000494003295898
    23905 /24212 0.956 0.000153779983521
    24329 /23743 1.032 0.000127077102661
    2633 /2590 1.04 0.000125885009766
    49707 /45800 1.216 0.000142097473145
    6944 /7566 0.804 0.000113010406494
    21041 /19659 1.116 0.000155925750732
    42281 /40691 1.068 0.000157117843628
    1585 /1487 1.104 0.000525951385498
    25810 /24693 1.072 0.000237941741943
    7459 /7242 1.056 8.89301300049e-05
    21518 /24318 0.764 0.000119924545288
    44365 /43895 1.016 0.000136137008667
    8580 /12453 0.408 0.000121116638184
    4632 /4722 0.948 0.000149011611938
    424869 /359190 1.3708 5.57899475098e-05
    619769 /465115 1.6668 5.00679016113e-05
    258475 /334190 0.5632 5.60283660889e-05
    204580 /197990 1.072 5.31673431396e-05
    75224 /177796 -0.1472 5.91278076172e-05
    387171 /423118 0.8264 5.60283660889e-05
    67123 /66706 1.012 6.48498535156e-05
    126082 /124128 1.0284 5.29289245605e-05
    308902 /415921 0.4736 5.07831573486e-05
    49843 /35398 1.8256 5.29289245605e-05
    305837 /483629 0.2704 6.48498535156e-05
    153306 /320852 -0.0296 5.10215759277e-05
    351961 /247954 1.848 6.69956207275e-05
    391163 /273094 1.8908 9.51290130615e-05
    295456 /183651 2.2052 8.60691070557e-05
    503435 /309183 2.2592 0.000121116638184
    18768 /30096 0.248 6.29425048828e-05
    30934 /100469 -0.3716 5.88893890381e-05
    122048 /121119 1.016 0.000112056732178
    284398 /264303 1.1572 5.3882598877e-05
    3555580 /4263493 0.66384 0.000150918960571
    6246647 /4904727 1.5424 0.0001540184021
    874846 /901292 0.93988 0.000221967697144
    3678359 /3152933 1.33524 0.000192165374756
    2055533 /1993815 1.05952 0.000176906585693
    4176375 /4140605 1.01768 0.000221014022827
    2182513 /2651029 0.6492 0.000219106674194
    3177925 /2849100 1.22692 0.000220060348511
    2947991 /2553120 1.30872 0.000182151794434
    4221659 /3703947 1.28736 0.00017786026001
    791860 /853891 0.8522 0.000198125839233
    1292539 /1349315 0.9154 0.000182867050171
    5607593 /4932547 1.26688 0.000189065933228
    2048307 /2092858 0.95844 0.000177145004272
    2210612 /2050167 1.15388 0.000177145004272
    1963353 /2052268 0.91068 0.000162839889526
    2089835 /2411633 0.729 0.000197887420654
    3625525 /3295555 1.19984 0.000164031982422
    4896056 /4708310 1.07968 0.000151872634888
    2809717 /2440782 1.29692 0.000343084335327
    ---
    100 1.016 3.1590461731e-05 1.29584352078
    1000 1.0226 0.000171959400177 5.44339622642
    10000 1.00926 6.62326812744e-05 0.385164644714
    100000 1.069684 0.000193011760712 2.91414686825

